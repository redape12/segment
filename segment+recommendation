-- 1. Добавляем новые столбцы
ALTER TABLE segment_aa1_balance 
ADD COLUMN segment VARCHAR(50) DEFAULT NULL 
COMMENT 'Сегмент клиента';

ALTER TABLE segment_aa1_balance 
ADD COLUMN segment_score INT DEFAULT 0 
COMMENT 'Числовая оценка сегмента (1-10, где 1 - лучший)';

ALTER TABLE segment_aa1_balance 
ADD COLUMN recommendation VARCHAR(255) DEFAULT NULL 
COMMENT 'Рекомендация по работе с клиентом';

-- 2. Обновляем сегменты
UPDATE segment_aa1_balance
SET segment = CASE 
  -- VIP Клиенты: идеальные по всем параметрам
  WHEN split_balance = 'high' AND split_ltv = 'high' AND split_tariff = 'high' 
    THEN 'VIP Клиенты'
  
  -- Перспективные: хороший баланс, могут расти
  WHEN split_balance = 'high' AND split_ltv IN ('high', 'low') AND split_tariff IN ('high', 'middle', 'low')
       AND split_ltv != 'middle'
    THEN 'Перспективные'
  
  -- Надёжные: стабильные, средние показатели
  WHEN split_balance = 'high' AND split_ltv = 'middle'
    THEN 'Надёжные'
  
  -- Требующие внимания: стабильные, но мало тратят
  WHEN split_balance = 'high' AND split_ltv = 'low' AND split_tariff IN ('middle', 'low')
    THEN 'Требующие внимания'
  
  -- Ценные с риском: хорошие траты, но средняя надёжность
  WHEN split_balance = 'middle' AND split_ltv = 'high'
    THEN 'Ценные с риском'
  
  -- Стандартные: средние по всем параметрам
  WHEN split_balance = 'middle' AND split_ltv = 'middle' AND split_tariff = 'middle'
    THEN 'Стандартные'
  
  -- Проблемные: плохие показатели
  WHEN split_balance IN ('middle', 'low') AND split_ltv = 'low'
       AND NOT (split_balance = 'low' AND split_ltv = 'low')
    THEN 'Проблемные'
  
  -- Нестабильные VIP: много тратят, но ненадёжны
  WHEN split_balance = 'low' AND split_ltv = 'high' AND split_tariff IN ('high', 'middle')
    THEN 'Нестабильные VIP'
  
  -- Рисковые активные: активные, но с рисками
  WHEN split_balance = 'low' AND split_ltv = 'high' AND split_tariff = 'low'
    THEN 'Рисковые активные'
  
  -- Критические: максимальный риск
  WHEN split_balance = 'low' AND split_ltv = 'low'
    THEN 'Критические'
  
  ELSE 'Прочие'
END;

-- 3. Обновляем числовые оценки сегментов (1 - лучший, 10 - худший)
UPDATE segment_aa1_balance
SET segment_score = CASE 
  WHEN segment = 'VIP Клиенты' THEN 1
  WHEN segment = 'Перспективные' THEN 2
  WHEN segment = 'Надёжные' THEN 3
  WHEN segment = 'Ценные с риском' THEN 4
  WHEN segment = 'Стандартные' THEN 5
  WHEN segment = 'Требующие внимания' THEN 6
  WHEN segment = 'Нестабильные VIP' THEN 7
  WHEN segment = 'Рисковые активные' THEN 8
  WHEN segment = 'Проблемные' THEN 9
  WHEN segment = 'Критические' THEN 10
  WHEN segment = 'Прочие' THEN 11
  ELSE 12
END;

-- 4. Обновляем рекомендации
UPDATE segment_aa1_balance
SET recommendation = CASE 
  WHEN segment = 'VIP Клиенты' THEN 'Персональный сервис, эксклюзивные предложения'
  WHEN segment = 'Перспективные' THEN 'Активная коммуникация, предложение доп. услуг'
  WHEN segment = 'Надёжные' THEN 'Стандартное обслуживание, периодические акции'
  WHEN segment = 'Требующие внимания' THEN 'Стимулирование активности, напоминания'
  WHEN segment = 'Ценные с риском' THEN 'Контроль баланса, уведомления об оплате'
  WHEN segment = 'Стандартные' THEN 'Базовая поддержка, массовые рассылки'
  WHEN segment = 'Проблемные' THEN 'Контроль оттока, специальные условия'
  WHEN segment = 'Нестабильные VIP' THEN 'Автооплата, премиальная поддержка'
  WHEN segment = 'Рисковые активные' THEN 'Уведомления о балансе, гибкие условия'
  WHEN segment = 'Критические' THEN 'Срочные меры по удержанию, персональный контакт'
  ELSE 'Базовое обслуживание'
END;
