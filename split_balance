-- 1. Сначала добавляем новый столбец split_balance
ALTER TABLE segment_aa1_balance 
ADD COLUMN split_balance VARCHAR(20) DEFAULT NULL 
COMMENT 'Категория баланса: low/middle/high';

-- 2. Теперь обновляем данные
UPDATE segment_aa1_balance AS t
JOIN (
  -- Подзапрос для расчета split_balance с учетом месяца и года
  SELECT 
    title,
    month,
    year,
    CASE 
      WHEN rnk <= CEIL(group_count * 1.0 / 3) THEN 'low'
      WHEN rnk <= CEIL(group_count * 1.0 / 3) + FLOOR(group_count * 1.0 / 3) THEN 'middle'
      ELSE 'high'
    END AS calculated_split
  FROM (
    SELECT 
      title,
      month,
      year,
      ROW_NUMBER() OVER (
        PARTITION BY 
          CASE 
            WHEN serv IN ('Телефония', 'КТВ') THEN 'group1'
            WHEN serv IN ('Интернет', 'Пакет', 'ОТТ') THEN 'group2'
          END,
          month,
          year
        ORDER BY negative_ratio DESC, title
      ) AS rnk,
      COUNT(*) OVER (
        PARTITION BY 
          CASE 
            WHEN serv IN ('Телефония', 'КТВ') THEN 'group1'
            WHEN serv IN ('Интернет', 'Пакет', 'ОТТ') THEN 'group2'
          END,
          month,
          year
      ) AS group_count
    FROM segment_aa1_balance
    WHERE serv IN ('Телефония', 'КТВ', 'Интернет', 'Пакет', 'ОТТ')
      AND month IS NOT NULL 
      AND year IS NOT NULL
  ) AS ranked
) AS s ON t.title = s.title AND t.month = s.month AND t.year = s.year
SET t.split_balance = s.calculated_split
WHERE t.serv IN ('Телефония', 'КТВ', 'Интернет', 'Пакет', 'ОТТ')
  AND t.month IS NOT NULL 
  AND t.year IS NOT NULL;
